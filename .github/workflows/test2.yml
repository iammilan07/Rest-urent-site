name: Tag Version

on:
  workflow_call:
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
      AWS_DEFAULT_REGION:
        required: true
  
    outputs:
      version_tag:
        description: "Generated version tag"
        value: ${{ jobs.tag.outputs.version_tag }}

jobs:
  tag:
    runs-on: ubuntu-latest
    outputs:
      version_tag: ${{ steps.generate-tag.outputs.version_tag }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # -------------------------------
      # DEBUG: check if secrets exist
      - name: Debug AWS Secrets
        run: |
          echo "Checking if AWS secrets exist..."
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
            echo "âŒ AWS_ACCESS_KEY_ID is EMPTY!"
          else
            echo "âœ… AWS_ACCESS_KEY_ID is set (masked)"
          fi

          if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            echo "âŒ AWS_SECRET_ACCESS_KEY is EMPTY!"
          else
            echo "âœ… AWS_SECRET_ACCESS_KEY is set (masked)"
          fi

          if [ -z "${{ secrets.AWS_DEFAULT_REGION }}" ]; then
            echo "âŒ AWS_DEFAULT_REGION is EMPTY!"
          else
            echo "âœ… AWS_DEFAULT_REGION is set: ${{ secrets.AWS_DEFAULT_REGION }}"
          fi
      # -------------------------------

      - name: Configure AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_DEFAULT_REGION }}

      - name: Verify AWS Authentication
        run: |
          echo "ðŸ” Verifying AWS credentials..."
          aws sts get-caller-identity
          echo "âœ… AWS authentication successful"

      
      - name: Summary
        run: |
          echo "## Version Tagging Complete ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "**Generated Tag:** \`${{ steps.generate-tag.outputs.version_tag }}\`" >> $GITHUB_STEP_SUMMARY
