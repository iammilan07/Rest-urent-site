name: Fetch Vault Secrets via OIDC

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

permissions:
  id-token: write   # Required for OIDC token
  contents: read    # Required for checkout

jobs:
  fetch-vault-secrets:
    runs-on: ubuntu-latest
    
    env:
      VAULT_ADDR: https://openbao.app.rigohr.com

    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Install Vault CLI and jq
      - name: Install Vault CLI and jq
        run: |
          set -e
          echo "ðŸ“¦ Installing dependencies..."
          
          # Install jq and unzip
          sudo apt-get update -y
          sudo apt-get install -y jq unzip
          
          # Download and install Vault binary from HashiCorp
          VAULT_VERSION="1.18.2"
          echo "â¬‡ï¸ Downloading Vault ${VAULT_VERSION}..."
          wget -q https://releases.hashicorp.com/vault/${VAULT_VERSION}/vault_${VAULT_VERSION}_linux_amd64.zip
          
          echo "ðŸ“‚ Extracting Vault..."
          unzip -q vault_${VAULT_VERSION}_linux_amd64.zip
          
          echo "ðŸ”§ Installing Vault..."
          sudo mv vault /usr/local/bin/
          sudo chmod +x /usr/local/bin/vault
          
          # Verify installation
          echo "âœ… Vault installed successfully:"
          vault --version

      # Step 3: Authenticate to Vault using GitHub OIDC
      - name: Authenticate with Vault via OIDC
        id: vault_login
        run: |
          set -e
          echo "ðŸ” Starting Vault authentication..."
          
          # Request GitHub OIDC token with correct audience
          echo "ðŸŽ« Requesting OIDC token from GitHub..."
          OIDC_TOKEN=$(curl -sS -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
                       "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=https://vault/login" | jq -r '.value')
          
          # Validate OIDC token
          if [ -z "$OIDC_TOKEN" ] || [ "$OIDC_TOKEN" = "null" ]; then
            echo "âŒ ERROR: Failed to retrieve OIDC token from GitHub"
            exit 1
          fi
          
          echo "âœ… OIDC token retrieved successfully"
          
          # Login to Vault using jwt-github auth backend
          echo "ðŸ”‘ Authenticating with Vault..."
          VAULT_TOKEN=$(vault write -field=token auth/jwt-github/login \
                          role="rigohr-github-test-role" \
                          jwt="$OIDC_TOKEN" 2>&1)
          
          # Check if authentication was successful
          if [ $? -ne 0 ]; then
            echo "âŒ ERROR: Vault authentication failed"
            echo "$VAULT_TOKEN"
            exit 1
          fi
          
          if [ -z "$VAULT_TOKEN" ]; then
            echo "âŒ ERROR: Vault token is empty"
            exit 1
          fi
          
          echo "âœ… Successfully authenticated with Vault"
          
          # Mask the token in GitHub Actions logs
          echo "::add-mask::$VAULT_TOKEN"
          
          # Export token for subsequent steps
          echo "VAULT_TOKEN=$VAULT_TOKEN" >> $GITHUB_ENV

      # Step 4: Fetch secret from Vault
      - name: Fetch secret from Vault
        run: |
          set -e
          echo "ðŸ“¥ Fetching secret from Vault..."
          
          # Fetch the secret from kvv2/github/test
          MY_SECRET=$(vault kv get -field=test kvv2/github/test 2>&1)
          
          # Check if secret fetch was successful
          if [ $? -ne 0 ]; then
            echo "âŒ ERROR: Failed to fetch secret from Vault"
            echo "$MY_SECRET"
            exit 1
          fi
          
          if [ -z "$MY_SECRET" ]; then
            echo "âŒ ERROR: Secret value is empty"
            exit 1
          fi
          
          echo "âœ… Secret retrieved successfully from kvv2/github/test"
          
          # Mask the secret in GitHub Actions logs
          echo "::add-mask::$MY_SECRET"
          
          # Export secret for subsequent steps
          echo "MY_SECRET=$MY_SECRET" >> $GITHUB_ENV

      # Step 5: Verify and use the secret
      - name: Use secret
        run: |
          echo "ðŸŽ‰ Secret is ready to use!"
          echo "ðŸ“ Secret length: ${#MY_SECRET} characters"
          
          # Example: Use secret for various purposes
          # Uncomment and modify based on your needs:
          
          # Example 1: Docker login
          # echo "$MY_SECRET" | docker login -u myusername --password-stdin registry.example.com
          
          # Example 2: Set as environment variable for app
          # export DATABASE_PASSWORD="$MY_SECRET"
          # node server.js
          
          # Example 3: Create Kubernetes secret
          # kubectl create secret generic app-secret --from-literal=password="$MY_SECRET"
          
          # Example 4: Use with Terraform
          # terraform apply -var="db_password=$MY_SECRET"
          
          # Example 5: SSH/Deploy
          # echo "$MY_SECRET" > ~/.ssh/deploy_key
          # chmod 600 ~/.ssh/deploy_key
          
          echo "âœ… You can now use \$MY_SECRET in any subsequent step"

      # Step 6: Example deployment step
      - name: Deploy application (example)
        run: |
          echo "ðŸš€ Deploying application..."
          echo "Using secret: ${MY_SECRET:0:4}****" # Show only first 4 chars
          
          # Add your actual deployment commands here
          # The secret is available as $MY_SECRET environment variable
          
          echo "âœ… Deployment completed successfully"

      # Step 7: Cleanup (optional)
      - name: Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up..."
          # Unset sensitive environment variables
          unset VAULT_TOKEN
          unset MY_SECRET
          echo "âœ… Cleanup completed"